# PelicanBuilder

## Overview

The PelicanBuilder handles static site generation using Pelican. It provides a clean interface for configuring and executing Pelican while integrating with the site's configuration system and output coordination.

## Class Design

```python
class PelicanBuilder:
    def __init__(self):
        pass  # Stateless builder
    
    def build(self, site_config: dict, pelican_config: dict, base_dir: Path = Path.cwd()) -> bool:
        # Configures and executes Pelican site generation
```

## Key Features

### Pelican Integration
- Uses proper Pelican settings configuration via `pelican.settings.configure_settings()`
- Creates complete content directory structure for Pelican
- Handles theme validation and configuration

### Configuration Management
- Merges site configuration with Pelican-specific settings
- Uses Pelican's DEFAULT_CONFIG as foundation
- Applies custom settings while preserving Pelican requirements

### Output Coordination
- Ensures Pelican output integrates with site build output
- Handles output directory creation and management
- Coordinates with gallery output for unified site structure

### Index Page Conflict Resolution
- Automatically detects content with `slug: index` that conflicts with default blog index
- Conditionally disables Pelican's default blog index (`INDEX_SAVE_AS = ''`) when conflicts exist
- Preserves custom index pages while maintaining default behavior when no conflicts occur
- Prevents "File to be overwritten" errors through intelligent configuration

## API Reference

### `build(site_config: dict, pelican_config: dict, base_dir: Path = Path.cwd()) -> bool`

Executes Pelican static site generation.

**Parameters:**
- `site_config`: Site orchestration configuration (output paths, etc.)
- `pelican_config`: Pelican-specific configuration (theme, content, etc.)
- `base_dir`: Base directory for resolving relative paths

**Returns:**
- `True` if Pelican build completed successfully

**Raises:**
- `PelicanError`: If Pelican configuration or execution fails

## Configuration Format

### Site Configuration (site.json)
```json
{
    "output_dir": "output",
    "content_dir": "content",
    "cdn": {
        "photos": "https://photos.cdn.example.com",
        "site": "https://site.cdn.example.com"
    }
}
```

### Pelican Configuration (pelican.json)
```json
{
    "author": "Your Name",
    "sitename": "Your Site",
    "site_url": "https://yoursite.com",
    "theme": "minimal",
    "timezone": "UTC",
    "default_lang": "en",
    "ignore_files": [".DS_Store"],
    "delete_output_directory": true
}
```

## Pelican Settings Integration

The builder creates proper Pelican settings:

```python
# Starts with Pelican defaults
settings = DEFAULT_CONFIG.copy()

# Applies custom configuration
settings.update({
    'AUTHOR': pelican_config['author'],
    'SITENAME': pelican_config['sitename'], 
    'SITEURL': pelican_config['site_url'],
    'OUTPUT_PATH': str(output_path),
    'PATH': str(content_path),
    # ... additional settings
})

# Uses Pelican's configuration system
final_settings = configure_settings(settings)
```

## Usage Patterns

### Basic Usage
```python
from build.pelican_builder import PelicanBuilder

builder = PelicanBuilder()
site_config = {"output_dir": "output"}
pelican_config = {
    "author": "Jane Doe",
    "sitename": "My Site", 
    "site_url": "https://mysite.com"
}
success = builder.build(site_config, pelican_config)
```

### Custom Paths
```python
from pathlib import Path
from build.pelican_builder import PelicanBuilder

builder = PelicanBuilder()
success = builder.build(
    site_config, 
    pelican_config,
    base_dir=Path("/project/root")
)
```

### Error Handling
```python
from build.pelican_builder import PelicanBuilder
from build.exceptions import PelicanError

builder = PelicanBuilder()
try:
    success = builder.build(site_config, pelican_config)
except PelicanError as e:
    print(f"Site generation failed: {e}")
```

## Content Directory Structure

The builder creates this content structure for Pelican:

```
content/
├── pages/
│   └── about.md       # About page content
├── articles/          # Blog posts (if any)
├── index.md          # Custom index page (optional)
└── static/           # Static assets
```

### Index Page Handling

**Custom Index Page** (`content/index.md`):
```markdown
---
title: Welcome
slug: index
status: published
---

# Welcome to our site
Custom homepage content.
```

**Result**: System detects `slug: index` and disables default blog index. Custom page becomes `/index.html`.

**No Custom Index**: System generates default Pelican blog index at `/index.html`.

## Output Integration

The PelicanBuilder coordinates with site build output:

```
output/
├── galleries/        # Generated by GalleriaBuilder  
├── pics/            # Organized photos
├── index.html       # Generated by PelicanBuilder
├── about/           # Generated by PelicanBuilder  
└── theme/           # CSS and assets
```

## Testing

PelicanBuilder is tested with unit tests that mock Pelican:

```python
@patch('build.pelican_builder.Pelican')
def test_build_pelican_site(mock_pelican_class):
    mock_pelican = Mock()
    mock_pelican_class.return_value = mock_pelican
    
    builder = PelicanBuilder()
    success = builder.build(site_config, pelican_config)
    
    assert success is True
    mock_pelican.run.assert_called_once()
```

## Theme Management

### Default Theme
- Uses Pelican's default theme if none specified
- Validates theme existence before building
- Creates theme directory structure if needed

### Custom Themes
- Supports custom theme paths in configuration
- Validates theme completeness
- Handles theme asset copying

## Error Handling

### Configuration Errors
- Missing required Pelican settings
- Invalid output or content directories
- Theme validation failures

### Execution Errors
- Pelican build failures
- Content processing errors
- Output directory permission issues

## Design Benefits

### Clean Integration
- Isolates Pelican complexity from orchestrator
- Provides simple configuration interface
- Handles all Pelican-specific details internally

### Configuration Flexibility
- Supports both site and Pelican configuration
- Uses Pelican's standard configuration system
- Allows easy customization and extension

### Output Coordination
- Integrates seamlessly with gallery output
- Maintains unified site structure
- Handles path resolution and directory creation